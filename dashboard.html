<!-- dashboard.html v.3.4-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mega VM Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<link rel="shortcut icon" href="/favicon.ico">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #ffffff;
            color: #333;
        }
        .chart-container {
            width: 98%;
            height: 400px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(148, 0, 211, 0.2);
            border: 1px solid rgba(148, 0, 211, 0.1);
        }
        .table-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(148, 0, 211, 0.2);
            margin-bottom: 30px;
            border: 1px solid rgba(148, 0, 211, 0.1);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: rgba(148, 0, 211, 0.1); color: #6a0dad; }
        h1, h2 { color: #6a0dad; }
        h1 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .time-selector { margin-left: auto; display: flex; }
        .time-button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #f8f9fa;
            border: 1px solid #6a0dad;
            border-radius: 4px;
            cursor: pointer;
            color: #6a0dad;
        }
        .time-button.active {
            background-color: #6a0dad;
            color: white;
            border-color: #6a0dad;
        }
        .warning-table {
            background-color: #fdf2f8;
            border: 1px solid #f9a8d4;
        }
        .warning-table h2 { color: #881337; }
    </style>
</head>
<body>
    <h1>
        Mega VM Monitoring Dashboard
        <div class="time-selector">
            <button class="time-button {% if current_time_range == '1h' %}active{% endif %}" onclick="changeTimeRange('1h')">1 час</button>
            <button class="time-button {% if current_time_range == '6h' %}active{% endif %}" onclick="changeTimeRange('6h')">6 часов</button>
            <button class="time-button {% if current_time_range == '12h' %}active{% endif %}" onclick="changeTimeRange('12h')">12 часов</button>
        </div>
    </h1>

    <div class="chart-container">
        <h2>CPU Load (%) over Time</h2>
        <canvas id="cpuChart"></canvas>
    </div>

    <div class="chart-container">
        <h2>Free Disk Space (GB) over Time</h2>
        <canvas id="diskChart"></canvas>
    </div>

    <div class="table-container">
        <h2>VM Groups – Total Threads</h2>
        <table>
            <thead>
                <tr><th>VM Group</th><th>Total Threads</th></tr>
            </thead>
            <tbody>
                {% for row in group_rows %}
                <tr><td>{{ row.group }}</td><td>{{ row.threads }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="table-container warning-table">
        <h2>Внимание! Потенциальный сбой ПО</h2>
        <table>
            <thead>
                <tr><th>Виртуальная машина</th><th>Группа</th><th>Средняя загрузка CPU (%)</th></tr>
            </thead>
            <tbody>
                {% for vm in low_cpu_vms %}
                <tr>
                    <td>{{ vm.vm_id }}</td>
                    <td>{{ vm.vm_group }}</td>
                    <td>{{ "%.2f"|format(vm.avg_cpu) }}</td>
                </tr>
                {% endfor %}
                {% if not low_cpu_vms %}
                <tr><td colspan="3" style="text-align: center;">Нет виртуальных машин с низкой загрузкой CPU</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

<script>
// === Функция для изменения временного диапазона ===
function changeTimeRange(timeRange) {
    window.location.href = '/dashboard?time_range=' + timeRange;
}

// === Вспомогательные функции для цветов ===
function interpolateColor(color1, color2, factor) {
    const hex = (c) => c.toString(16).padStart(2, '0');
    const r1 = parseInt(color1.slice(1, 3), 16);
    const g1 = parseInt(color1.slice(3, 5), 16);
    const b1 = parseInt(color1.slice(5, 7), 16);
    const r2 = parseInt(color2.slice(1, 3), 16);
    const g2 = parseInt(color2.slice(3, 5), 16);
    const b2 = parseInt(color2.slice(5, 7), 16);

    const r = Math.round(r1 + factor * (r2 - r1));
    const g = Math.round(g1 + factor * (g2 - g1));
    const b = Math.round(b1 + factor * (b2 - b1));

    return `#${hex(r)}${hex(g)}${hex(b)}`;
}

function getProfileColor(groupName, vmIndex, vmCount) {
    if (groupName === 'Cyber') {
        return '#9400D3';
    }

    const baseColors = [
        '#FF4500', '#1E90FF', '#32CD32', '#FFD700', '#FF1493',
        '#00CED1', '#FF8C00', '#8A2BE2', '#DC143C', '#228B22'
    ];

    let groupHash = 0;
    for (let i = 0; i < groupName.length; i++) {
        groupHash = groupName.charCodeAt(i) + ((groupHash << 5) - groupHash);
    }
    const colorIndex = Math.abs(groupHash) % baseColors.length;
    const baseColor = baseColors[colorIndex];

    const step = Math.min(vmIndex, 9) / 9;
    const grayColor = '#D3D3D3';

    return interpolateColor(baseColor, grayColor, step);
}

// === Подготовка данных ===
const vmData = {{ vms_by_group | tojson }};
const groupOrder = {{ group_order | tojson }};
const vmVersions = {{ vm_versions | tojson }};

const cpuDatasets = [];
const diskDatasets = [];

groupOrder.forEach((group) => {
    const vmsInGroup = Object.keys(vmData[group]);
    const vmCount = vmsInGroup.length;

    vmsInGroup.forEach((vm, vmIndex) => {
        const color = getProfileColor(group, vmIndex, vmCount);
        const versions = vmVersions[vm] || { bas_version: 'N/A', project_version: 'N/A' };

        const datasetBase = {
            label: vm + ' (' + group + ')',
            borderColor: color,
            backgroundColor: 'rgba(0,0,0,0)',
            tension: 0.2,
            bas_version: versions.bas_version,
            project_version: versions.project_version,
            // --- ИЗМЕНЕНИЕ 1: Делаем точки более заметными и "кликабельными" ---
            pointRadius: 3,
            pointHoverRadius: 6,
        };

        cpuDatasets.push({
            ...datasetBase,
            data: vmData[group][vm]['cpu'],
        });

        const diskData = vmData[group][vm]['disk'].map(point => ({
            x: point.x,
            y: point.y / (1024 * 1024 * 1024)
        }));

        diskDatasets.push({
            ...datasetBase,
            data: diskData,
        });
    });
});

// --- ИЗМЕНЕНИЕ 2: Настройки tooltip для одной точки ---
const pointTooltipOptions = {
    mode: 'point',
    intersect: true,
    callbacks: {
        label: function(context) {
            const fullLabel = context.dataset.label || '';
            const labelParts = fullLabel.split(' (');
            const vmId = labelParts[0];
            const profiles = labelParts.length > 1 ? labelParts[1].slice(0, -1) : 'N/A';

            let valueLine = '';
            if (context.parsed.y !== null) {
                if (context.chart.canvas.id === 'diskChart') {
                    valueLine = `${vmId}: ${context.parsed.y.toFixed(2)} GB`;
                } else {
                    valueLine = `${vmId}: ${context.parsed.y.toFixed(2)}%`;
                }
            }

            const basVersion = context.dataset.bas_version || 'N/A';
            const projectVersion = context.dataset.project_version || 'N/A';

            return [
                valueLine,
                `BAS ver: ${basVersion}`,
                `Project ver: ${projectVersion}`,
                `Profiles: ${profiles}`
            ];
        }
    }
};

// --- ИЗМЕНЕНИЕ 3: Общие опции для графиков ---
const commonChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        mode: 'point',
        intersect: true,
    },
    scales: {
        x: {
            type: 'time',
            time: { unit: 'minute', tooltipFormat: 'MMM d, HH:mm', displayFormats: { minute: 'HH:mm' } },
            title: { display: true, text: 'Time (Moscow)' },
            timezone: 'Europe/Moscow'
        }
    },
    plugins: {
        legend: { position: 'top' },
        tooltip: pointTooltipOptions
    }
};


// === CPU Chart ===
const cpuCtx = document.getElementById('cpuChart').getContext('2d');
new Chart(cpuCtx, {
    type: 'line',
    data: { datasets: cpuDatasets },
    options: {
        ...commonChartOptions,
        scales: {
            ...commonChartOptions.scales,
            y: { min: 0, max: 100, title: { display: true, text: 'CPU %' } }
        }
    }
});

// === Disk Chart ===
const diskCtx = document.getElementById('diskChart').getContext('2d');
new Chart(diskCtx, {
    type: 'line',
    data: { datasets: diskDatasets },
    options: {
        ...commonChartOptions,
        scales: {
            ...commonChartOptions.scales,
            y: {
                min: 0,
                max: 65,
                title: { display: true, text: 'Free Disk (GB)' },
                ticks: { stepSize: 5, callback: function(value) { return value + ' GB'; } }
            }
        }
    }
});

</script>
</body>
</html>
